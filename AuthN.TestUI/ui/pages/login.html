<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login</title>
    <link rel="stylesheet" href="../style.css" />
    <script src="../main.js"></script>
    <script>
      window.addEventListener('load', async () => {

        const token = localStorage.getItem('token');
        const tokenIsValid = !!token; // TODO!!
        if (tokenIsValid) { return location = '/members'; }

        q2a('#btnFacebook')[0].addEventListener('click', () => {
          return location = 'https://localhost:44357/fb-auth/login?redirect=login';
        });

        var codeQueryIndex = location.search.indexOf('code=');
        if (codeQueryIndex != -1) {
          var providerCode = location.search.substring(codeQueryIndex + 5);
          var tokenUrl = 'https://localhost:44357/fb-auth/login_int?code=' + providerCode;
          var response = await fetch(tokenUrl);
          var body = await response.json();
          if (body.login) {
            localStorage.setItem('token', body.login.token);
            return location = '/members';
          }
          else if (body.registration) {
            var qs = new URLSearchParams({ ...body.registration, providerCode });
            return location = "/register?" + qs;
          }
        }

        var form = document.forms[0];
        form.addEventListener('submit', async event => {
          event.preventDefault();
          if (form.checkValidity()) {
            const url = 'https://localhost:44357/l-auth/login';
            const params = new URLSearchParams(new FormData(form));
            const body = JSON.stringify(Object.fromEntries(params.entries()));
            const headers = { 'Content-Type': 'application/json' };
            const response = await fetch(url, { method: 'post', body, headers });
            const json = await response.json();
            if (response.ok) {
              localStorage.setItem('token', json.token);
              return location = '/members';
            }
          }
        });
      });
    </script>
  </head>
  <body>
    <h3>Login</h3>
    <input type="button" id="btnFacebook" value="Login (fb)"/>

    <form>
      <input type="text" name="username" required pattern=".{6,}" placeholder="username"/>
      <input type="password" name="password" required pattern=".{8,}" placeholder="password"/>
      <input type="submit"/>
    </form>
    <p>No account? Register <a href="/register">here</a></p>

    <p>Go back <a href="/">home</a></p>
  </body>
</html>
