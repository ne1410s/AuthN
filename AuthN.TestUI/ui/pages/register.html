<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Register</title>
    <link rel="stylesheet" href="../style.css" />
    <script src="../main.js"></script>
    <script>
      window.addEventListener('load', () => {

        var form = document.forms[0];
        var entries = new URLSearchParams(location.search.substring(1)).entries();
        for(var [key, value] of entries) {
          if (key == 'dateOfBirth') value = value.substring(0, 10);
          (form[key] ?? {}).value = value;
        }

        form.addEventListener('submit', async event => {
          event.preventDefault();
          if (form.checkValidity()) {
            const url = 'https://localhost:44357/fb-auth/register';
            const params = new URLSearchParams(new FormData(form));
            const body = JSON.stringify(Object.fromEntries(params.entries()));
            const headers = { 'Content-Type': 'application/json' };
            const response = await fetch(url, { method: 'post', body, headers });
            const json = await response.json();
            if (response.ok) {
              localStorage.setItem('token', json.token);
              return location = '/members';
            }
          }
        });
      });
    </script>
  </head>
  <body>
    <h3>Register</h3>
    <form>
      <div>
        <input type="hidden" name="providerCode"/>
      </div>
      <div>
        <input type="hidden" name="providerId"/>
      </div>
      <div>
        <input type="hidden" name="checksum"/>
      </div>
      <div>
        <input type="email" name="email" readonly placeholder="email"/>
      </div>
      <div>
        <input type="text" name="forename" required pattern=".{2,50}" placeholder="forename"/>
      </div>
      <div>
        <input type="text" name="surname" required pattern=".{2,50}" placeholder="surname"/>
      </div>
      <div>
        <input type="date" name="dateOfBirth" required/>
      </div>
      <div>
        <input type="submit" value="Submit"/>
      </div>
    </form>
    <p>Go back <a href="/">home</a></p>
  </body>
</html>
